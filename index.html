<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Horario - La Comarc√≥n</title>
    <style>
        /* Estilo b√°sico para el bot√≥n de favorito */
        .favorite-btn {
            cursor: pointer;
            font-size: 1.5rem; /* Tama√±o del icono */
            color: #ccc; /* Color por defecto (no favorito) */
            transition: color 0.2s;
            display: inline-flex; /* Asegura que el icono est√© centrado si hay espacio extra */
            align-items: center;
            justify-content: center;
        }
        .favorite-btn.is-favorite {
            color: #FFD700; /* Color cuando es favorito (dorado) */
        }
        .detalle-actividad {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #555;
            background-color: #f9fafb;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        .actividad:hover {
            cursor: pointer;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="max-w-md mx-auto p-4">
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold">Horario - La Comarc√≥n</h1>
            <p class="text-sm text-gray-600">Torrevieja ¬∑ 2025</p>
        </div>

        <div class="flex justify-center mb-4">
            <button id="dia1Btn" class="px-4 py-2 bg-blue-500 text-white rounded-l-lg">S√°bado</button>
            <button id="dia2Btn" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-r-lg">Domingo</button>
        </div>

        <div class="flex overflow-x-auto mb-4 space-x-2">
            <button class="filter-btn px-3 py-1 text-sm bg-gray-200 rounded" data-categoria="todas">Todas</button>
            <button class="filter-btn px-3 py-1 text-sm bg-yellow-300 text-yellow-900 rounded" data-categoria="favoritos">‚≠ê Favoritos</button>
            <button class="filter-btn px-3 py-1 text-sm bg-purple-200 rounded" data-categoria="rol_mesa">Rol de mesa</button>
            <button class="filter-btn px-3 py-1 text-sm bg-pink-200 rounded" data-categoria="rol_vivo">Rol en vivo</button>
            <button class="filter-btn px-3 py-1 text-sm bg-blue-200 rounded" data-categoria="videojuegos">Videojuegos</button>
            <button class="filter-btn px-3 py-1 text-sm bg-indigo-200 rounded" data-categoria="juegos_mesa">Juegos de mesa</button>
            <button class="filter-btn px-3 py-1 text-sm bg-yellow-200 rounded" data-categoria="deportes">Deportes</button>
            <button class="filter-btn px-3 py-1 text-sm bg-red-200 rounded" data-categoria="concursos">Concursos</button>
            <button class="filter-btn px-3 py-1 text-sm bg-green-200 rounded" data-categoria="talleres">Talleres</button>
            <button class="filter-btn px-3 py-1 text-sm bg-orange-200 rounded" data-categoria="charlas">Charlas</button>
            <button class="filter-btn px-3 py-1 text-sm bg-gray-300 rounded" data-categoria="otros">Otros</button>
        </div>

        <div id="horario" class="space-y-4">
        </div>
    </div>

    <script>
        let actividades = { sabado: [], domingo: [] };
        let diaActual = "sabado";
        let filtroActual = "todas";
        // Almac√©n para los IDs de actividades favoritas
        let favoritos = new Set(JSON.parse(localStorage.getItem('horarioFavoritos')) || []);

        const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQVrAqpQlI4uhoa45UBxoRxsrnUB54QJ_LR5WgScbfFEGwkUannAa-0jRONdjsOwRoJ2hYNbMMAqcw-/pub?output=csv"; // Aseg√∫rate de que el nombre y la ruta coincidan con tu archivo CSV

        function agruparPorHora(lista) {
            const mapa = {};
            lista.forEach(act => {
                // Nuevo filtro para favoritos
                if (filtroActual === "favoritos" && !favoritos.has(act.id)) return;
                // Filtro existente por categor√≠a
                if (filtroActual !== "todas" && filtroActual !== "favoritos" && act.tipo !== filtroActual) return;

                if (!mapa[act.hora]) mapa[act.hora] = [];
                mapa[act.hora].push(act);
            });
            return mapa;
        }

        function renderHorario() {
            const contenedor = document.getElementById("horario");
            contenedor.innerHTML = "";
            const actividadesPorHora = agruparPorHora(actividades[diaActual]);
            const horas = Object.keys(actividadesPorHora).sort();

            if (horas.length === 0) {
                if (filtroActual === "favoritos") {
                    contenedor.innerHTML = "<p class='text-center text-gray-500'>No tienes actividades marcadas como favoritas. Marca el icono de estrella en alguna actividad para a√±adirla aqu√≠.</p>";
                } else {
                    contenedor.innerHTML = "<p class='text-center text-gray-500'>No hay actividades para esta selecci√≥n.</p>";
                }
                return;
            }

            horas.forEach(hora => {
                const bloque = document.createElement("div");
                bloque.innerHTML = `<h3 class="text-sm font-semibold text-gray-600 mb-2">üïí ${hora}</h3>`;
                actividadesPorHora[hora].forEach(act => {
                    const card = document.createElement("div");
                    card.className = "bg-white p-4 mb-2 rounded shadow flex justify-between items-center actividad";

                    // Determina si la actividad actual es favorita
                    const isFavoriteClass = favoritos.has(act.id) ? 'is-favorite' : '';
                    // Determina la clase de Font Awesome para la estrella (rellena o contorno)
                    const starIconClass = favoritos.has(act.id) ? 'fas' : 'far';

                    card.innerHTML = `
                        <div>
                            <h2 class="text-lg font-bold">${act.titulo}</h2>
                            <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full ${getColor(act.tipo)}">${formateaCategoria(act.tipo)}</span>
                            <div class="detalle-actividad">
                                ${act.detalle || 'No hay informaci√≥n adicional.'}
                                ${act.enlace ? `<div class="mt-2"><a href="${act.enlace}" target="_blank" class="text-blue-600 underline font-semibold">Apuntarse / M√°s info</a></div>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="text-sm text-gray-500 ml-4 whitespace-nowrap mr-2">‚è± ${act.duracion}</div>
                            <span class="favorite-btn ${isFavoriteClass}" data-id="${act.id}">
                                <i class="${starIconClass} fa-star"></i>
                            </span>
                        </div>
                    `;
                    // A√±adimos evento para mostrar/ocultar detalle al clicar en la card (excepto en la estrella)
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.favorite-btn')) return; // No hacer toggle si clic en favorito
                        const detalle = card.querySelector('.detalle-actividad');
                        if (detalle.style.display === 'block') {
                            detalle.style.display = 'none';
                        } else {
                            detalle.style.display = 'block';
                        }
                    });

                    bloque.appendChild(card);
                });
                contenedor.appendChild(bloque);
            });

            // A√±adir event listeners a los nuevos botones de favorito
            document.querySelectorAll('.favorite-btn').forEach(button => {
                button.addEventListener('click', toggleFavorite);
            });
        }

        function formateaCategoria(tipo) {
            const mapa = {
                rol_mesa: "Rol de mesa",
                rol_vivo: "Rol en vivo",
                videojuegos: "Videojuegos",
                juegos_mesa: "Juegos de mesa",
                deportes: "Deportes",
                concursos: "Concursos",
                talleres: "Talleres",
                charlas: "Charlas",
                otros: "Otros",
                favoritos: "Favoritos"
            };
            return mapa[tipo] || tipo;
        }

        function getColor(tipo) {
            switch (tipo) {
                case "rol_mesa": return "bg-purple-100 text-purple-700";
                case "rol_vivo": return "bg-pink-100 text-pink-700";
                case "videojuegos": return "bg-blue-100 text-blue-700";
                case "juegos_mesa": return "bg-indigo-100 text-indigo-700";
                case "deportes": return "bg-yellow-100 text-yellow-700";
                case "concursos": return "bg-red-100 text-red-700";
                case "talleres": return "bg-green-100 text-green-700";
                case "charlas": return "bg-orange-100 text-orange-700";
                case "otros": return "bg-gray-200 text-gray-800";
                default: return "bg-gray-100 text-gray-700";
            }
        }

        function actualizarFiltroActivo() {
            document.querySelectorAll(".filter-btn").forEach(btn => {
                if (btn.getAttribute("data-categoria") === filtroActual) {
                    btn.classList.add("ring", "ring-offset-1", "ring-gray-500");
                } else {
                    btn.classList.remove("ring", "ring-offset-1", "ring-gray-500");
                }
            });
        }

        // Funci√≥n para alternar el estado de favorito
        function toggleFavorite(event) {
            const button = event.currentTarget; // El span .favorite-btn
            const icon = button.querySelector('i'); // El elemento <i> dentro del span (el icono de estrella)
            const id = button.dataset.id; // Obtenemos el ID de la actividad

            if (favoritos.has(id)) {
                favoritos.delete(id); // Desmarcar
                button.classList.remove('is-favorite'); // Quita la clase de color
                icon.classList.remove('fas'); // Cambia a estrella vac√≠a
                icon.classList.add('far');
            } else {
                favoritos.add(id); // Marcar
                button.classList.add('is-favorite'); // A√±ade la clase de color
                icon.classList.remove('far'); // Cambia a estrella rellena
                icon.classList.add('fas');
            }
            // Guarda la lista actualizada en localStorage
            localStorage.setItem('horarioFavoritos', JSON.stringify(Array.from(favoritos)));

            // Si el filtro actual es "favoritos", necesitamos re-renderizar para ocultar/mostrar
            if (filtroActual === "favoritos") {
                renderHorario();
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            const validLines = lines.filter(line => line.trim() !== '');

            if (validLines.length === 0) {
                console.warn("CSV vac√≠o o solo cabeceras.");
                return [];
            }

            const headers = validLines[0].split(",").map(h => h.trim());
            return validLines.slice(1).map(row => {
                const values = row.split(",").map(c => c.trim());
                const obj = {};
                headers.forEach((h, i) => obj[h] = values[i]);
                return obj;
            });
        }

        function cargarDesdeCSV() {
            fetch(URL_CSV)
                .then(resp => {
                    if (!resp.ok) {
                        throw new Error(`HTTP error! status: ${resp.status}`);
                    }
                    return resp.text();
                })
                .then(data => {
                    const registros = parseCSV(data);
                    actividades = { sabado: [], domingo: [] };
                    registros.forEach(r => {
                        // Aseg√∫rate de que las columnas existan y no est√©n vac√≠as, incluyendo 'id'
                        if (r["id"] && r["hora"] && r["titulo"] && r["tipo"] && r["duracion"] && r["dia"]) {
                            const actividad = {
                                id: r["id"], // Capturamos el ID
                                hora: r["hora"],
                                titulo: r["titulo"],
                                tipo: r["tipo"],
                                duracion: r["duracion"],
                                detalle: r["detalle"] || "" // Asumiendo que la columna 'detalle' existe en el CSV
                                enlace: r["enlace"] || ""
                            };
                            const dia = r["dia"]?.toLowerCase();
                            if (dia?.includes("sab")) actividades.sabado.push(actividad);
                            else if (dia?.includes("dom")) actividades.domingo.push(actividad);
                        } else {
                            console.warn("Fila con datos incompletos o incorrectos (o falta 'id'):", r);
                        }
                    });
                    renderHorario();
                    actualizarFiltroActivo();
                })
                .catch(err => {
                    console.error("Error cargando CSV:", err);
                    document.getElementById("horario").innerHTML = "<p class='text-center text-red-500'>Error al cargar datos. Aseg√∫rate de que el archivo 'horario.csv' est√© en el mismo directorio y sea accesible.</p>";
                });
        }

        document.getElementById("dia1Btn").addEventListener("click", () => {
            diaActual = "sabado";
            document.getElementById("dia1Btn").classList.replace("bg-blue-100", "bg-blue-500");
            document.getElementById("dia1Btn").classList.replace("text-blue-700", "text-white");
            document.getElementById("dia2Btn").classList.replace("bg-blue-500", "bg-blue-100");
            document.getElementById("dia2Btn").classList.replace("text-white", "text-blue-700");
            renderHorario();
        });

        document.getElementById("dia2Btn").addEventListener("click", () => {
            diaActual = "domingo";
            document.getElementById("dia2Btn").classList.replace("bg-blue-100", "bg-blue-500");
            document.getElementById("dia2Btn").classList.replace("text-blue-700", "text-white");
            document.getElementById("dia1Btn").classList.replace("bg-blue-500", "bg-blue-100");
            document.getElementById("dia1Btn").classList.replace("text-white", "text-blue-700");
            renderHorario();
        });

        document.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                filtroActual = btn.getAttribute("data-categoria");
                actualizarFiltroActivo();
                renderHorario();
            });
        });

        cargarDesdeCSV();
    </script>
</body>
</html>

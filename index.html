<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="icon" type="image/png" href="estrella-trans.png"/>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <title>Horario - La ComarCON</title>

    <style>
        /* Definici√≥n de la fuente personalizada */
        @font-face {
            font-family: 'ComarCON_FONT';
            src: url('fonts/FORTQUINSY.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        /* Estilos generales */
        body {
            background-color: #990099;
            font-family: 'Inter', sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Contenedor principal */
        .main-container {
            max-width: 420px;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            box-sizing: border-box;
        }

        /* Estilos para el t√≠tulo H1 */
        h1 {
            font-family: 'ComarCON_FONT', cursive;
            color: #ecf0f1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            transition: font-size 0.3s ease-in-out;
            text-align: center;
            width: 100%;
        }

        /* Estilos para el subt√≠tulo del evento */
        .subtitle-text {
            color: #e0e0e0;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        /* Estilos para la imagen del logo */
        .logo-img {
            height: 50px;
            width: auto;
            cursor: pointer;
            position: absolute;
            left: 1rem;
            top: 1rem;
        }

        /* Estilo para el contenedor del icono de navegaci√≥n (info/back) */
        .nav-icon-container {
            position: absolute;
            right: 1rem;
            top: 1rem;
        }
        .nav-icon {
            font-size: 2.2rem;
            color: #ecf0f1;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-icon:hover {
            color: #FFD700;
        }

        /* Estilos para los botones de d√≠a (S√°bado/Domingo) */
        .day-button {
            padding: 0.5rem 1rem;
            font-weight: 600;
            border-radius: 0.75rem;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1;
            text-align: center;
        }
        .day-button.active {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .day-button:not(.active) {
            background-color: #bfdbfe;
            color: #1d4ed8;
        }

        /* Estilos para los botones de filtro */
        .filter-button {
            padding: 0.25rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .filter-button.active-filter {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            position: relative;
            z-index: 10;
        }

        /* Estilos para las tarjetas de actividad */
        .activity-card {
            background-color: #ffffff;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: .75rem !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative; /* Esencial para que el icono se posicione correctamente */
        }
        .activity-card:hover {
            background-color: #f3f4f6;
        }
        .activity-card h2 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .activity-card .category-tag {
            display: inline-block;
            margin-top: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        .activity-card .duration-text {
            font-size: 0.875rem;
            color: #6b7280;
            white-space: nowrap;
            margin-left: 1rem;
            margin-right: 0.5rem;
        }
        .activity-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Estilos para el bot√≥n de favoritos */
        .favorite-btn {
            cursor: pointer;
            font-size: 1.5rem;
            color: #ccc;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .favorite-btn.is-favorite {
            color: #FFD700;
        }

        /* Detalle de la actividad (oculto por defecto) */
        .activity-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease, opacity 0.35s ease, padding 0.25s ease;
            opacity: 0;
            margin-top: 0;
            padding: 0 1rem; /* padding reducido cuando est√° cerrado */
            font-size: 0.9rem;
            color: #555;
            background-color: #f9fafb;
            border-radius: .75rem;
            border: 1px solid #e5e7eb;
        }

        .activity-detail.open {
            opacity: 1;
            margin-top: 0.5rem;
            padding: 0.75rem 1rem;
        }
        .activity-detail a {
            color: #2563eb;
            text-decoration: underline;
            font-weight: 600;
        }

        /* Contenedores de vista (horario/informaci√≥n) */
        .view-container {
            display: none;
        }
        .view-container.active-view {
            display: block;
        }

        /* Estilos para la secci√≥n de Informaci√≥n */
        .info-section-content {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .info-section-content h2 {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .info-section-content h2:first-of-type {
            margin-top: 0;
        }
        .info-section-content p {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #4b5563;
            margin-bottom: 1rem;
        }
        .info-section-content ul {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }
        .info-section-content ul li {
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        .info-section-content a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }
        .info-section-content a:hover {
            text-decoration: underline;
        }
        .map-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem auto;
            border-radius: 0.75rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .faq-item {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed #e5e7eb;
        }
        .faq-item h3 {
            font-size: 1.05rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        .faq-item p {
            font-size: 0.9rem;
            color: #4b5563;
        }

        /* Estilos para indicador desplegar tarjeta */
        .expand-icon {
            position: absolute;
            left: 50%;
            bottom: -0.8rem;
            transform: translateX(-50%);
            font-size: 1.2rem;
            color: #ddd;
            transition: transform 0.2s, color 0.2s;
            cursor: pointer;
        }

        .expand-icon.is-open {
            transform: translateX(-50%) rotate(180deg);
            color: #999;
        }
    </style>
</head>
<body class="text-gray-800">
<div class="max-w-md mx-auto p-4 relative">
    <div class="mb-4">
        <img src="estrella-trans.png" alt="Logo La Comarc√≥n" class="logo-img" id="logo-btn" />

        <a href="#" id="nav-toggle-btn" class="nav-icon-container">
            <i class="fas fa-info nav-icon"></i>
        </a>

        <h1 id="main-title" class="text-size-horario">Cargando...</h1>
        <p id="event-subtitle" class="subtitle-text">Cargando...</p>
    </div>

    <div id="horario-view" class="view-container active-view">
        <div class="flex justify-center mb-4 space-x-2">
            <button id="dia1Btn" class="day-button active">S√°bado</button>
            <button id="dia2Btn" class="day-button">Domingo</button>
        </div>

        <div id="filter-buttons-container" class="flex overflow-x-auto mb-4 space-x-2 pb-2">
        </div>

        <div id="horario" class="space-y-4"></div>
    </div>

    <div id="info-view" class="view-container">
        <div class="info-section-content">
            <p id="info-welcome-text"></p>

            <div class="map-container">
                <h2 id="map-section-title" class="text-xl font-bold mb-4">Mapa</h2> <a id="event-map-link" href="#" target="_blank"> <img id="event-map-image" src="" alt="Mapa del evento" class="map-image" style="display: none;">
            </a>
                <p class="mt-2 text-sm text-gray-600">Haz clic en la imagen para ver el mapa en alta resoluci√≥n.</p>
            </div>

            <h2 id="info-faq-title"></h2>
            <div id="info-faq-list">
            </div>

            <h2>Contacto y Redes Sociales</h2>
            <ul>
                <li>Email: <a id="info-contact-email" href="#" target="_blank"></a></li>
                <li>Facebook: <a id="info-social-facebook" href="#" target="_blank"></a></li>
                <li>Instagram: <a id="info-social-instagram" href="#" target="_blank"></a></li>
                <li>Web: <a id="info-website-url" href="#" target="_blank"></a></li>
            </ul>

            <h2>Sobre Nosotros</h2>
            <p id="info-about-us-text"></p>
        </div>
    </div>
</div>

<script>
    let actividades = { sabado: [], domingo: [] };
    let diaActual = "sabado";
    let filtroActual = "todas";
    let favoritos = new Set(JSON.parse(localStorage.getItem('horarioFavoritos')) || []);
    let actividadAbierta = null;
    let appConfig = null;

    const mainTitleElement = document.getElementById('main-title');
    const eventSubtitleElement = document.getElementById('event-subtitle');
    const navToggleButton = document.getElementById('nav-toggle-btn');
    const navToggleIcon = navToggleButton.querySelector('i');
    const logoBtn = document.getElementById('logo-btn');

    const horarioView = document.getElementById('horario-view');
    const infoView = document.getElementById('info-view');

    const URL_CSV = "https://corsproxy.io/?url=https://docs.google.com/spreadsheets/d/e/2PACX-1vQVrAqpQlI4uhoa45UBxoRxsrnUB54QJ_LR5WgScbfFEGwkUannAa-0jRONdjsOwRoJ2hYNbMMAqcw-/pub?gid=0&single=true&output=csv";
    const CONFIG_JSON_WEB_URL = "https://gamergarage.github.io/Comarcon/config.json";

    // --- Polyfill para el objeto Android en la versi√≥n web ---
    if (typeof Android === 'undefined') {
        window.Android = {
            showToast: (message) => console.log(`[WEB APP] Toast: ${message}`),
            programarAlertaActividad: (id, titulo, hora, dia) => {
                alert(`Alerta para '${titulo}' programada (no disponible en web).`);
            },
            cancelarAlertaActividad: (id) => {
                alert("Alerta cancelada (no disponible en web).");
            },
            openUrl: (url) => window.open(url, '_blank'),
            notifyContentRendered: () => {
                console.log("[WEB APP] notifyContentRendered llamado (versi√≥n web).");
            },
            getAppConfig: () => {
                return fetch(CONFIG_JSON_WEB_URL)
                    .then(response => response.ok ? response.json() : Promise.reject(`HTTP error! status: ${response.status}`))
                    .then(data => JSON.stringify(data))
                    .catch(error => {
                        console.error("Error al cargar config.json en web:", error);
                        return JSON.stringify({
                            "titulos_app": { "h1_horario": "Horario", "h1_informacion": "Informaci√≥n" },
                            "subtitulo_evento": "Error de carga",
                            "seccion_informacion": { "titulo_mapa": "Mapa", "texto_bienvenida": "Error al cargar la informaci√≥n.", "titulo_faqs": "FAQs", "texto_sobre_nosotros": "Informaci√≥n no disponible." },
                            "categorias_filtro": [{ "id": "todas", "nombre_mostrar": "Todas", "clase_tailwind": "bg-gray-200 text-gray-800" }, { "id": "favoritos", "nombre_mostrar": "‚≠ê Favoritos", "clase_tailwind": "bg-yellow-200 text-yellow-800" }]
                        });
                    });
            }
        };
    }

    // --- FUNCIONES DE MANEJO DE VISTAS Y DATOS ---

    function updateUIFromConfig() {
        if (!appConfig) return;

        mainTitleElement.innerText = appConfig.titulos_app?.h1_horario || "Horario";
        eventSubtitleElement.innerText = appConfig.subtitulo_evento || "Evento";

        const infoSection = appConfig.seccion_informacion;
        if (infoSection) {
            document.getElementById('info-welcome-text').innerText = infoSection.texto_bienvenida || '';
            const mapTitleElement = document.getElementById('map-section-title');
            if (mapTitleElement) mapTitleElement.innerText = infoSection.titulo_mapa || "Mapa";

            const mapImageElement = document.getElementById('event-map-image');
            const mapLinkElement = document.getElementById('event-map-link');

            if (mapImageElement && infoSection.url_imagen_mapa) {
                mapImageElement.src = infoSection.url_imagen_mapa;
                mapImageElement.style.display = 'block';
                mapLinkElement.href = infoSection.url_pdf_mapa || '#';
                mapLinkElement.onclick = (e) => {
                    e.preventDefault();
                    if (Android.openUrl) {
                        Android.openUrl(infoSection.url_pdf_mapa);
                    }
                };
            }

            document.getElementById('info-faq-title').innerText = infoSection.titulo_faqs || '';
            const faqListElement = document.getElementById('info-faq-list');
            if (faqListElement && Array.isArray(infoSection.faqs)) {
                faqListElement.innerHTML = '';
                infoSection.faqs.forEach(faq => {
                    const faqItem = document.createElement('div');
                    faqItem.classList.add('faq-item');
                    faqItem.innerHTML = `<h3>${faq.pregunta}</h3><p>${faq.respuesta}</p>`;
                    faqListElement.appendChild(faqItem);
                });
            }

            const contactEmailElement = document.getElementById('info-contact-email');
            if (contactEmailElement && infoSection.email_contacto) {
                contactEmailElement.href = `mailto:${infoSection.email_contacto}`;
                contactEmailElement.innerText = infoSection.email_contacto;
            }

            const socialFacebookElement = document.getElementById('info-social-facebook');
            if (socialFacebookElement && infoSection.red_social_facebook) {
                socialFacebookElement.href = infoSection.red_social_facebook;
                socialFacebookElement.innerText = "Facebook Oficial";
            }

            const socialInstagramElement = document.getElementById('info-social-instagram');
            if (socialInstagramElement && infoSection.red_social_instagram) {
                socialInstagramElement.href = infoSection.red_social_instagram;
                socialInstagramElement.innerText = "Instagram Oficial";
            }

            const websiteUrlElement = document.getElementById('info-website-url');
            if (websiteUrlElement && infoSection.url_web) {
                websiteUrlElement.href = infoSection.url_web;
                websiteUrlElement.innerText = infoSection.url_web.replace(/(^\w+:|^)\/\//, '');
            }

            document.getElementById('info-about-us-text').innerText = infoSection.texto_sobre_nosotros || '';
        }

        renderFilterButtons();
        renderHorario();
        adjustTitleFontSize();
    }

    function adjustTitleFontSize() {
        const logoRect = logoBtn.getBoundingClientRect();
        const navIconRect = navToggleButton.getBoundingClientRect();
        const availableWidth = navIconRect.left - logoRect.right;
        const effectiveWidth = availableWidth - 20;
        const minFontSizePx = 20;
        const maxFontSizePx = 45;
        const minEffectiveWidth = 150;
        const maxEffectiveWidth = 300;

        let newFontSizePx;
        if (effectiveWidth <= minEffectiveWidth) {
            newFontSizePx = minFontSizePx;
        } else if (effectiveWidth >= maxEffectiveWidth) {
            newFontSizePx = maxFontSizePx;
        } else {
            newFontSizePx = minFontSizePx + (effectiveWidth - minEffectiveWidth) * (maxFontSizePx - minFontSizePx) / (maxEffectiveWidth - minEffectiveWidth);
        }
        mainTitleElement.style.fontSize = `${newFontSizePx}px`;
    }

    function agruparPorHora(lista) {
        const mapa = {};
        lista.forEach(act => {
            if (filtroActual === "favoritos" && !favoritos.has(act.id)) return;
            if (filtroActual !== "todas" && filtroActual !== "favoritos" && act.tipo !== filtroActual) return;
            if (!mapa[act.hora]) mapa[act.hora] = [];
            mapa[act.hora].push(act);
        });
        return mapa;
    }

    function renderHorario() {
        const contenedor = document.getElementById("horario");
        contenedor.innerHTML = "";
        const actividadesPorHora = agruparPorHora(actividades[diaActual]);
        const horas = Object.keys(actividadesPorHora).sort();
        actividadAbierta = null;

        if (horas.length === 0 && appConfig) {
            contenedor.innerHTML = "<p class='text-center text-gray-300'>No hay actividades para esta selecci√≥n.</p>";
            return;
        }

        horas.forEach(hora => {
            const bloque = document.createElement("div");
            bloque.innerHTML = `<h3 class="text-sm font-semibold text-gray-200 mb-2">üïí ${hora}</h3>`;
            actividadesPorHora[hora].forEach(act => {
                const card = document.createElement("div");
                card.className = "bg-white p-4 mb-2 rounded shadow flex justify-between items-center activity-card";
                card.dataset.id = act.id;

                const isFavoriteClass = favoritos.has(act.id) ? 'is-favorite' : '';
                const starIconClass = favoritos.has(act.id) ? 'fas' : 'far';

                let detalleHtml = '';
                let expandIconHtml = '';
                if (act.detalle || act.enlace) {
                    const descripcionHtml = act.detalle ? `<p>${act.detalle}</p>` : '';
                    const enlaceHtml = act.enlace ? `<div class="mt-2"><a href="${act.enlace}" onclick="Android.openUrl(this.href); return false;" class="text-blue-600 underline font-semibold">M√°s info</a></div>` : '';
                    detalleHtml = `<div class="activity-detail">${descripcionHtml}${enlaceHtml}</div>`;
                    expandIconHtml = `<i class="fas fa-chevron-down expand-icon" data-id="${act.id}"></i>`;
                }

                card.innerHTML = `
                    <div class="relative w-full flex flex-col">
                        <div class="flex justify-between items-center w-full">
                            <div>
                                <h2 class="text-lg font-bold">${act.titulo}</h2>
                                <span class="category-tag ${getCategoryStyle(act.tipo)}">
                                    ${getCategoryDisplayName(act.tipo)}
                                </span>
                            </div>
                            <div class="flex items-center">
                                <div class="duration-text">‚è± ${act.duracion}</div>
                                <span class="favorite-btn ${isFavoriteClass}" data-id="${act.id}">
                                    <i class="${starIconClass} fa-star"></i>
                                </span>
                            </div>
                        </div>
                        ${detalleHtml}
                        <div class="flex justify-center mt-2">
                            ${expandIconHtml}
                        </div>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if (e.target.closest('.favorite-btn')) return;
                    const detalle = card.querySelector('.activity-detail');
                    const expandIcon = card.querySelector('.expand-icon');

                    if (detalle) {
                        if (actividadAbierta && actividadAbierta !== card) {
                            const oldDetail = actividadAbierta.querySelector('.activity-detail');
                            const oldExpandIcon = actividadAbierta.querySelector('.expand-icon');
                            oldDetail.style.maxHeight = "0";
                            oldDetail.classList.remove('open');
                            if (oldExpandIcon) oldExpandIcon.classList.remove('is-open');
                            if (oldDetail._resizeObserver) oldDetail._resizeObserver.disconnect();
                        }

                        const isCurrentlyOpen = detalle.classList.contains('open');
                        if (isCurrentlyOpen) {
                            detalle.style.maxHeight = "0";
                            detalle.classList.remove('open');
                            actividadAbierta = null;
                            if (detalle._resizeObserver) detalle._resizeObserver.disconnect();
                        } else {
                            detalle.classList.add('open');
                            detalle.style.maxHeight = detalle.scrollHeight + "px";
                            actividadAbierta = card;
                            const resizeObserver = new ResizeObserver(() => {
                                if (detalle.classList.contains('open')) {
                                    detalle.style.maxHeight = detalle.scrollHeight + "px";
                                }
                            });
                            resizeObserver.observe(detalle);
                            detalle._resizeObserver = resizeObserver;
                        }
                        if (expandIcon) expandIcon.classList.toggle('is-open', !isCurrentlyOpen);
                    }
                });
                bloque.appendChild(card);
            });
            contenedor.appendChild(bloque);
        });

        document.querySelectorAll('.favorite-btn').forEach(button => {
            button.addEventListener('click', toggleFavorite);
        });
    }

    function getCategoryDisplayName(idCategoria) {
        if (!appConfig?.categorias_filtro) return idCategoria;
        const categoria = appConfig.categorias_filtro.find(cat => cat.id === idCategoria);
        return categoria ? categoria.nombre_mostrar : idCategoria;
    }

    function getCategoryStyle(idCategoria) {
        if (!appConfig?.categorias_filtro) return "bg-gray-100 text-gray-700";
        const categoria = appConfig.categorias_filtro.find(cat => cat.id === idCategoria);
        return categoria ? categoria.clase_tailwind : "bg-gray-100 text-gray-700";
    }

    function renderFilterButtons() {
        const container = document.getElementById('filter-buttons-container');
        container.innerHTML = '';

        if (!appConfig?.categorias_filtro) return;

        appConfig.categorias_filtro.forEach(categoria => {
            const button = document.createElement('button');
            button.onclick = () => setFiltro(categoria.id);
            button.classList.add('filter-button', ...categoria.clase_tailwind.split(' '));
            if (categoria.id === filtroActual) {
                button.classList.add('active-filter');
            }
            button.textContent = categoria.nombre_mostrar;
            container.appendChild(button);
        });
    }

    function toggleFavorite(event) {
        const button = event.currentTarget;
        const icon = button.querySelector('i');
        const id = button.dataset.id;
        let actividadCompleta = actividades.sabado.find(act => act.id === id) || actividades.domingo.find(act => act.id === id);

        if (!actividadCompleta) {
            if (Android.showToast) Android.showToast("Error: Actividad no encontrada.");
            return;
        }

        if (favoritos.has(id)) {
            favoritos.delete(id);
            button.classList.remove('is-favorite');
            icon.classList.replace('fas', 'far');
            if (Android.cancelarAlertaActividad) Android.cancelarAlertaActividad(actividadCompleta.id);
        } else {
            favoritos.add(id);
            button.classList.add('is-favorite');
            icon.classList.replace('far', 'fas');
            if (Android.programarAlertaActividad) {
                const diaActividad = actividadCompleta.dia.toLowerCase().includes("sab") ? "sabado" : "domingo";
                Android.programarAlertaActividad(actividadCompleta.id, actividadCompleta.titulo, actividadCompleta.hora, diaActividad);
            }
        }

        localStorage.setItem('horarioFavoritos', JSON.stringify(Array.from(favoritos)));
        if (Android.showToast) Android.showToast(`Favoritos guardados: ${favoritos.size} actividades.`);
        if (filtroActual === "favoritos") renderHorario();
    }

    function setFiltro(filtro) {
        filtroActual = filtro;
        document.querySelectorAll(".filter-button").forEach(btn => btn.classList.remove("active-filter"));
        const btnActivo = Array.from(document.querySelectorAll(".filter-button")).find(btn => btn.onclick.toString().includes(`setFiltro('${filtro}')`));
        if (btnActivo) btnActivo.classList.add("active-filter");
        renderHorario();
    }

    function parseCSV(text) {
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",").map(h => h.trim());
        return lines.slice(1).map(row => {
            const values = row.split(",").map(c => c.trim());
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i]);
            return obj;
        });
    }

    function cargarCSV() {
        return fetch(URL_CSV)
            .then(resp => {
                if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
                return resp.text();
            })
            .then(data => {
                const registros = parseCSV(data);
                actividades = { sabado: [], domingo: [] };
                registros.forEach(r => {
                    if (r["id"] && r["hora"] && r["titulo"] && r["tipo"] && r["duracion"] && r["dia"]) {
                        const actividad = {
                            id: r["id"].trim(),
                            hora: r["hora"].trim(),
                            titulo: r["titulo"].trim(),
                            tipo: r["tipo"].toLowerCase().trim(),
                            duracion: r["duracion"].trim(),
                            dia: r["dia"].trim(),
                            detalle: r["detalle"]?.trim() || "",
                            enlace: r["enlace"]?.trim() || ""
                        };
                        const dia = r["dia"].toLowerCase();
                        if (dia.includes("sab")) actividades.sabado.push(actividad);
                        else if (dia.includes("dom")) actividades.domingo.push(actividad);
                    }
                });
            })
            .catch(error => {
                if (Android.showToast) Android.showToast("Error al cargar los datos del horario.");
                throw error;
            });
    }

    function updateTitleAndIcon(view) {
        if (!appConfig) return;
        mainTitleElement.innerText = view === 'horario' ? appConfig.titulos_app.h1_horario : appConfig.titulos_app.h1_informacion;
        adjustTitleFontSize();
        navToggleIcon.className = view === 'horario' ? 'fas fa-info nav-icon' : 'fas fa-arrow-left nav-icon';
    }

    function toggleView() {
        const isHorarioActive = horarioView.classList.contains('active-view');
        horarioView.classList.toggle('active-view', !isHorarioActive);
        infoView.classList.toggle('active-view', isHorarioActive);
        updateTitleAndIcon(isHorarioActive ? 'info' : 'horario');
    }

    // --- INICIALIZACI√ìN ---
    async function initApp() {
        try {
            const configData = await (Android.getAppConfig ? Android.getAppConfig() : Android.getAppConfig());
            appConfig = JSON.parse(configData);
            await cargarCSV();
            updateUIFromConfig();

            // Notifica a la aplicaci√≥n nativa que el contenido est√° listo
            if (typeof Android !== 'undefined' && Android.notifyContentRendered) {
                Android.notifyContentRendered();
            }
        } catch (error) {
            console.error("Error en la inicializaci√≥n de la app:", error);
            if (Android.showToast) Android.showToast("No se pudieron cargar todos los datos de la app.");
        }
    }

    document.addEventListener('DOMContentLoaded', initApp);
    document.getElementById("dia1Btn").addEventListener("click", () => {
        if (horarioView.classList.contains('active-view')) {
            diaActual = "sabado";
            document.getElementById("dia1Btn").classList.add("active");
            document.getElementById("dia2Btn").classList.remove("active");
            renderHorario();
        }
    });

    document.getElementById("dia2Btn").addEventListener("click", () => {
        if (horarioView.classList.contains('active-view')) {
            diaActual = "domingo";
            document.getElementById("dia2Btn").classList.add("active");
            document.getElementById("dia1Btn").classList.remove("active");
            renderHorario();
        }
    });

    navToggleButton.addEventListener('click', (e) => {
        e.preventDefault();
        toggleView();
    });

    logoBtn.addEventListener('click', () => {
        if (infoView.classList.contains('active-view')) {
            toggleView();
        }
    });

    window.addEventListener('resize', adjustTitleFontSize);
</script>
</body>
</html>



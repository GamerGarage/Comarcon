<script>
  let diaActual = "sabado";
  let filtroActual = "todas";
  let actividades = { sabado: [], domingo: [] };

  const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQVrAqpQlI4uhoa45UBxoRxsrnUB54QJ_LR5WgScbfFEGwkUannAa-0jRONdjsOwRoJ2hYNbMMAqcw-/pub?gid=0&single=true&output=csv";

  function formateaCategoria(tipo) {
    const mapa = {
      rol_mesa: "Rol de mesa",
      rol_vivo: "Rol en vivo",
      videojuegos: "Videojuegos",
      juegos_mesa: "Juegos de mesa",
      deportes: "Deportes",
      concursos: "Concursos",
      talleres: "Talleres",
      charlas: "Charlas",
      otros: "Otros"
    };
    return mapa[tipo] || tipo;
  }

  function getColor(tipo) {
    switch (tipo) {
      case "rol_mesa": return "bg-purple-100 text-purple-700";
      case "rol_vivo": return "bg-pink-100 text-pink-700";
      case "videojuegos": return "bg-blue-100 text-blue-700";
      case "juegos_mesa": return "bg-indigo-100 text-indigo-700";
      case "deportes": return "bg-yellow-100 text-yellow-700";
      case "concursos": return "bg-red-100 text-red-700";
      case "talleres": return "bg-green-100 text-green-700";
      case "charlas": return "bg-orange-100 text-orange-700";
      case "otros": return "bg-gray-200 text-gray-800";
      default: return "bg-gray-100 text-gray-700";
    }
  }

  function agruparPorHora(lista) {
    const mapa = {};
    lista.forEach(act => {
      if (filtroActual !== "todas" && act.tipo !== filtroActual) return;
      if (!mapa[act.hora]) mapa[act.hora] = [];
      mapa[act.hora].push(act);
    });
    return mapa;
  }

  function renderHorario() {
    const contenedor = document.getElementById("horario");
    contenedor.innerHTML = "";
    const actividadesPorHora = agruparPorHora(actividades[diaActual]);
    Object.keys(actividadesPorHora).sort().forEach(hora => {
      const bloque = document.createElement("div");
      bloque.innerHTML = `<h3 class="text-sm font-semibold text-gray-600 mb-2">üïí ${hora}</h3>`;
      actividadesPorHora[hora].forEach(act => {
        const card = document.createElement("div");
        card.className = "bg-white p-4 mb-2 rounded shadow flex justify-between items-center";
        card.innerHTML = `
          <div>
            <h2 class="text-lg font-bold">${act.titulo}</h2>
            <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full ${getColor(act.tipo)}">${formateaCategoria(act.tipo)}</span>
          </div>
          <div class="text-sm text-gray-500 ml-4 whitespace-nowrap">‚è± ${act.duracion}</div>
        `;
        bloque.appendChild(card);
      });
      contenedor.appendChild(bloque);
    });
  }

  function actualizarFiltroActivo() {
    document.querySelectorAll(".filter-btn").forEach(btn => {
      if (btn.getAttribute("data-categoria") === filtroActual) {
        btn.classList.add("ring", "ring-offset-1", "ring-gray-500");
      } else {
        btn.classList.remove("ring", "ring-offset-1", "ring-gray-500");
      }
    });
  }

  function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
    const data = lines.slice(1).map(row => {
      const values = row.split(",").map(c => c.trim());
      const obj = {};
      headers.forEach((h, i) => obj[h] = values[i]);
      return obj;
    });
    return data;
  }

  function cargarDatos() {
    fetch(URL_CSV)
      .then(res => res.text())
      .then(texto => {
        const filas = parseCSV(texto);
        actividades = { sabado: [], domingo: [] };
        filas.forEach(f => {
          const obj = {
            hora: f.hora || "00:00",
            titulo: f.titulo || "Sin t√≠tulo",
            tipo: f.tipo || "otros",
            duracion: f.duracion || "1h"
          };
          if (f.dia === "sabado" || f.dia === "s√°bado") actividades.sabado.push(obj);
          else if (f.dia === "domingo") actividades.domingo.push(obj);
        });
        renderHorario();
        actualizarFiltroActivo();
      })
      .catch(err => {
        console.error("Error al cargar el CSV", err);
        document.getElementById("horario").innerHTML = "<p class='text-center text-red-500'>Error al cargar el horario</p>";
      });
  }

  // Listeners
  document.getElementById("dia1Btn").addEventListener("click", () => {
    diaActual = "sabado";
    document.getElementById("dia1Btn").classList.replace("bg-blue-100", "bg-blue-500");
    document.getElementById("dia1Btn").classList.replace("text-blue-700", "text-white");
    document.getElementById("dia2Btn").classList.replace("bg-blue-500", "bg-blue-100");
    document.getElementById("dia2Btn").classList.replace("text-white", "text-blue-700");
    renderHorario();
  });

  document.getElementById("dia2Btn").addEventListener("click", () => {
    diaActual = "domingo";
    document.getElementById("dia2Btn").classList.replace("bg-blue-100", "bg-blue-500");
    document.getElementById("dia2Btn").classList.replace("text-blue-700", "text-white");
    document.getElementById("dia1Btn").classList.replace("bg-blue-500", "bg-blue-100");
    document.getElementById("dia1Btn").classList.replace("text-white", "text-blue-700");
    renderHorario();
  });

  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      filtroActual = btn.getAttribute("data-categoria");
      actualizarFiltroActivo();
      renderHorario();
    });
  });

  // Inicio
  cargarDatos();
</script>


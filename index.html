<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <title>Horario - La Comarc√≥n</title>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-md mx-auto p-4">
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold">Horario - La Comarc√≥n</h1>
      <p class="text-sm text-gray-600">Torrevieja ¬∑ 2025</p>
    </div>

    <!-- Selector de D√≠a -->
    <div class="flex justify-center mb-4">
      <button id="dia1Btn" class="px-4 py-2 bg-blue-500 text-white rounded-l-lg">S√°bado</button>
      <button id="dia2Btn" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-r-lg">Domingo</button>
    </div>

    <!-- Filtro de Categor√≠a -->
    <div class="flex overflow-x-auto mb-4 space-x-2">
      <button class="filter-btn px-3 py-1 text-sm bg-gray-200 rounded" data-categoria="todas">Todas</button>
      <button class="filter-btn px-3 py-1 text-sm bg-purple-200 rounded" data-categoria="rol_mesa">Rol de mesa</button>
      <button class="filter-btn px-3 py-1 text-sm bg-pink-200 rounded" data-categoria="rol_vivo">Rol en vivo</button>
      <button class="filter-btn px-3 py-1 text-sm bg-blue-200 rounded" data-categoria="videojuegos">Videojuegos</button>
      <button class="filter-btn px-3 py-1 text-sm bg-indigo-200 rounded" data-categoria="juegos_mesa">Juegos de mesa</button>
      <button class="filter-btn px-3 py-1 text-sm bg-yellow-200 rounded" data-categoria="deportes">Deportes</button>
      <button class="filter-btn px-3 py-1 text-sm bg-red-200 rounded" data-categoria="concursos">Concursos</button>
      <button class="filter-btn px-3 py-1 text-sm bg-green-200 rounded" data-categoria="talleres">Talleres</button>
      <button class="filter-btn px-3 py-1 text-sm bg-orange-200 rounded" data-categoria="charlas">Charlas</button>
      <button class="filter-btn px-3 py-1 text-sm bg-gray-300 rounded" data-categoria="otros">Otros</button>
      <button class="filter-btn px-3 py-1 text-sm bg-yellow-300 rounded" data-categoria="favoritos">Favoritos ‚òÖ</button>
    </div>

    <!-- Contenido del Horario -->
    <div id="horario" class="space-y-4"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQVrAqpQlI4uhoa45UBxoRxsrnUB54QJ_LR5WgScbfFEGwkUannAa-0jRONdjsOwRoJ2hYNbMMAqcw-/pub?gid=0&single=true&output=csv";

    let actividades = [];
    let diaActual = "S√°bado";
    let filtroActual = "todas";
    let favoritos = new Set(JSON.parse(localStorage.getItem("favoritos") || "[]"));

    function guardarFavoritos() {
      localStorage.setItem("favoritos", JSON.stringify(Array.from(favoritos)));
    }

    function formateaCategoria(tipo) {
      const mapa = {
        rol_mesa: "Rol de mesa",
        rol_vivo: "Rol en vivo",
        videojuegos: "Videojuegos",
        juegos_mesa: "Juegos de mesa",
        deportes: "Deportes",
        concursos: "Concursos",
        talleres: "Talleres",
        charlas: "Charlas",
        otros: "Otros"
      };
      return mapa[tipo] || tipo;
    }

    function getColor(tipo) {
      switch (tipo) {
        case "rol_mesa": return "bg-purple-100 text-purple-700";
        case "rol_vivo": return "bg-pink-100 text-pink-700";
        case "videojuegos": return "bg-blue-100 text-blue-700";
        case "juegos_mesa": return "bg-indigo-100 text-indigo-700";
        case "deportes": return "bg-yellow-100 text-yellow-700";
        case "concursos": return "bg-red-100 text-red-700";
        case "talleres": return "bg-green-100 text-green-700";
        case "charlas": return "bg-orange-100 text-orange-700";
        case "otros": return "bg-gray-200 text-gray-800";
        default: return "bg-gray-100 text-gray-700";
      }
    }

    function agruparPorHora(lista) {
      const mapa = {};
      lista.forEach(act => {
        if (filtroActual !== "todas") {
          if (filtroActual === "favoritos") {
            if (!favoritos.has(act.id)) return;
          } else if (act.tipo !== filtroActual) {
            return;
          }
        }
        if (act.dia !== diaActual) return;

        if (!mapa[act.hora]) mapa[act.hora] = [];
        mapa[act.hora].push(act);
      });
      return mapa;
    }

    function renderHorario() {
      const contenedor = document.getElementById("horario");
      contenedor.innerHTML = "";

      const actividadesPorHora = agruparPorHora(actividades);
      if (Object.keys(actividadesPorHora).length === 0) {
        contenedor.innerHTML = `<p class="text-center text-gray-500">No hay actividades para esta selecci√≥n.</p>`;
        return;
      }

      Object.keys(actividadesPorHora).sort().forEach(hora => {
        const bloque = document.createElement("div");
        bloque.innerHTML = `<h3 class="text-sm font-semibold text-gray-600 mb-2">üïí ${hora}</h3>`;

        actividadesPorHora[hora].forEach(act => {
          const isFavorito = favoritos.has(act.id);
          const card = document.createElement("div");
          card.className = "bg-white p-4 mb-2 rounded shadow flex justify-between items-center";

          card.innerHTML = `
            <div>
              <h2 class="text-lg font-bold">${act.titulo}</h2>
              <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full ${getColor(act.tipo)}">${formateaCategoria(act.tipo)}</span>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-gray-500 whitespace-nowrap">‚è± ${act.duracion}</div>
              <button aria-label="Marcar favorito" class="favorito-btn text-xl ${isFavorito ? 'text-yellow-400' : 'text-gray-300'} cursor-pointer select-none" data-id="${act.id}">‚òÖ</button>
            </div>
          `;

          bloque.appendChild(card);
        });

        contenedor.appendChild(bloque);
      });

      // A√±adir evento a los botones de favoritos
      document.querySelectorAll(".favorito-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          if (favoritos.has(id)) {
            favoritos.delete(id);
            btn.classList.remove("text-yellow-400");
            btn.classList.add("text-gray-300");
          } else {
            favoritos.add(id);
            btn.classList.remove("text-gray-300");
            btn.classList.add("text-yellow-400");
          }
          guardarFavoritos();
          if (filtroActual === "favoritos") renderHorario();
        });
      });
    }

    // Eventos botones d√≠a
    document.getElementById("dia1Btn").addEventListener("click", () => {
      diaActual = "S√°bado";
      document.getElementById("dia1Btn").classList.replace("bg-blue-100", "bg-blue-500");
      document.getElementById("dia1Btn").classList.replace("text-blue-700", "text-white");
      document.getElementById("dia2Btn").classList.replace("bg-blue-500", "bg-blue-100");
      document.getElementById("dia2Btn").classList.replace("text-white", "text-blue-700");
      renderHorario();
    });

    document.getElementById("dia2Btn").addEventListener("click", () => {
      diaActual = "Domingo";
      document.getElementById("dia2Btn").classList.replace("bg-blue-100", "bg-blue-500");
      document.getElementById("dia2Btn").classList.replace("text-blue-700", "text-white");
      document.getElementById("dia1Btn").classList.replace("bg-blue-500", "bg-blue-100");
      document.getElementById("dia1Btn").classList.replace("text-white", "text-blue-700");
      renderHorario();
    });

    // Eventos filtros categor√≠a
    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        filtroActual = btn.getAttribute("data-categoria");

        // Actualizar clases de filtro para borde seleccionado
        document.querySelectorAll(".filter-btn").forEach(b => {
          b.classList.remove("border-2", "border-blue-600");
        });
        btn.classList.add("border-2", "border-blue-600");

        renderHorario();
      });
    });

    // Cargar actividades desde CSV y mostrar
    function cargarActividades() {
      Papa.parse(urlCSV, {
        download: true,
        header: true,
        complete: function(results) {
          actividades = results.data.filter(a => a.id && a.dia && a.hora && a.titulo && a.tipo && a.duracion);
          renderHorario();
        },
        error: function(err) {
          console.error("Error cargando CSV:", err);
        }
      });
    }

    cargarActividades();
  </script>
</body>
</html>
